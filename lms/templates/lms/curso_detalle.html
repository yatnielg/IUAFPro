{% extends "panel/grafico.html" %}
{% load static %}

{% block main_content %}

<style>
  .curso-hero {
    background: linear-gradient(135deg, #5A2CA0, #7A4ED0);
    border-radius: 12px;
    color: #fff;
    padding: 24px 28px;
  }
  .curso-hero-title {
    font-size: 1.6rem;
    font-weight: 700;
  }
  .curso-hero-subtitle {
    font-size: 0.95rem;
    opacity: 0.9;
  }
  .curso-chip {
    display: inline-flex;
    align-items: center;
    font-size: 0.8rem;
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(255,255,255,0.15);
    margin: 3px 6px 3px 0;
  }
  .curso-chip i {
    font-size: 16px;
    margin-right: 4px;
  }
  .curso-hero-img {
    max-width: 390px;
    width: 100%;
    border-radius: 10px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.35);
    background: #fff;
    object-fit: cover;
  }

  /* Timeline módulos */
  .modulos-timeline {
    position: relative;
    padding-left: 24px;
    margin-left: 8px;
  }
  .modulos-timeline::before {
    content: "";
    position: absolute;
    top: 0;
    left: 10px;
    width: 2px;
    height: 100%;
    background: linear-gradient(to bottom, #5A2CA0, #BFA6F0);
    opacity: 0.6;
  }
  .modulo-item {
    position: relative;
    margin-bottom: 20px;
  }
  .modulo-badge {
    position: absolute;
    left: -2px;
    top: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #5A2CA0;
    color: #fff;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 0 4px rgba(90,44,160,0.25);
  }
  .modulo-card {
    margin-left: 20px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  }
  .modulo-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .modulo-title {
    font-weight: 600;
    font-size: 0.98rem;
  }
  .modulo-meta {
    font-size: 0.75rem;
    color: #9e9e9e;
  }

  /* Lecciones */
  .leccion-card {
    border-radius: 8px;
    border: 1px solid rgba(0,0,0,0.04);
    background: #fafafa;
    margin-bottom: 10px;
    padding: 10px 12px;
  }
  .leccion-title {
    font-size: 0.93rem;
    font-weight: 600;
  }
  .leccion-meta {
    font-size: 0.76rem;
    color: #757575;
  }
  .leccion-actions a {
    font-size: 0.75rem;
  }

  .pill-actividad {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    font-size: 0.74rem;
    padding: 2px 8px;
    border: 1px solid rgba(0,0,0,0.1);
    background: #fff;
    margin-right: 6px;
    margin-bottom: 4px;
  }
  .pill-actividad i {
    font-size: 16px;
    margin-right: 3px;
  }

  .texto-cita {
    font-style: italic;
    font-size: 0.9rem;
    border-left: 4px solid #5A2CA0;
    padding-left: 10px;
    color: #616161;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 text-white mb-0">
    <i class="material-icons align-middle mr-1">school</i>
    {{ curso.nombre }}
  </h1>
  <a href="{% url 'lms:mis_cursos' %}" class="btn btn-outline-light btn-sm">
    <i class="material-icons align-middle">arrow_back</i> Mis cursos
  </a>
</div>

{# ================= HERO DEL CURSO ================= #}
<div class="curso-hero mb-4 shadow-sm">
  <div class="row align-items-center">
    <div class="col-md-8">
      <div class="curso-hero-title mb-1">
        {{ curso.nombre }}
      </div>
      <div class="curso-hero-subtitle mb-3">
        {{ curso.descripcion|default:"En este espacio encontrarás los contenidos, actividades y lineamientos operativos del curso." }}
      </div>

      <div class="mb-2">
        <span class="curso-chip">
          <i class="material-icons">menu_book</i>
          Programa:  {{ curso.programa.nombre }}
        </span>
        {% if curso.grupo %}
          <span class="curso-chip">
            <i class="material-icons">group</i>
            Grupo: {{ curso.grupo.nombre }}
          </span>
        {% endif %}
      </div>

      <div class="mb-2">
        {% if curso.fecha_inicio %}
          <span class="curso-chip">
            <i class="material-icons">event</i>
            Inicio: {{ curso.fecha_inicio|date:"d/m/Y" }}
          </span>
        {% endif %}
        {% if curso.fecha_fin %}
          <span class="curso-chip">
            <i class="material-icons">event_busy</i>
            Fin: {{ curso.fecha_fin|date:"d/m/Y" }}
          </span>
        {% endif %}
      </div>

      {% if curso.docente %}
        <div class="mb-2">
          <span class="curso-chip">
            <i class="material-icons">person</i>
            Docente: {{ curso.docente.get_full_name|default:curso.docente.username }}
          </span>
        </div>
      {% endif %}

      <p class="texto-cita mt-3 mb-0 text-white">
        “Saber cómo trabajar a lo largo del curso es muy importante para que tengas éxito.”
      </p>
    </div>

    <div class="col-md-4 text-center mt-3 mt-md-0">
      {% if curso.portada %}
        <img src="{{ curso.portada.url }}" alt="Portada del curso" class="curso-hero-img">
      {% else %}
        <img src="{% static 'img/lms/hero-default.png' %}" alt="Curso" class="curso-hero-img">
      {% endif %}
    </div>
  </div>
</div>

{# ================= CONTENIDO DEL CURSO ================= #}
<div class="card mb-4">
  <div class="card-header card-header-primary card-header-icon">
    <div class="card-icon"><i class="material-icons">view_list</i></div>
    <h4 class="card-title mb-0">Plan de trabajo del curso</h4>
  </div>

  <div class="card-body">
    {% if modulos %}
      <div class="row">
        <div class="col-lg-12">
          <div class="modulos-timeline">
            {% for m in modulos %}
              <div class="modulo-item">
                <div class="modulo-badge">{{ forloop.counter }}</div>

                <div class="card modulo-card">
                  <div class="card-body">
                    <div class="modulo-header mb-2">
                      <div>
                        <div class="modulo-title">
                          Módulo {{ forloop.counter }}: {{ m.titulo }}
                        </div>
                        <div class="modulo-meta">
                          {% with m.lecciones.count as total_lecciones %}
                            {{ total_lecciones }} lección{{ total_lecciones|pluralize }}
                          {% endwith %}
                        </div>
                      </div>
                    </div>

                    {% if m.lecciones.all %}
                      {% for l in m.lecciones.all %}
                        <div class="leccion-card">
                          <div class="d-flex justify-content-between align-items-start">
                            <div>
                              <div class="leccion-title">
                                Lección {{ forloop.counter }}: {{ l.titulo }}
                              </div>

                              {# CONTENIDO DE LA LECCIÓN (TEXTO / IFRAME / LO QUE SEA) #}
                              {% if l.contenido_html %}
                                <div class="leccion-meta mt-1">
                                  {{ l.contenido_html|safe }}
                                </div>
                              {% endif %}

                              {# MATERIAL ADJUNTO #}
                              {% if l.archivo %}
                                <div class="leccion-meta mt-1">
                                  <a href="{{ l.archivo.url }}" target="_blank" rel="noopener">
                                    <i class="material-icons align-middle" style="font-size:16px;">attach_file</i>
                                    Material descargable
                                  </a>
                                </div>
                              {% endif %}
                            </div>

                            {# Actividades a la derecha #}
                            {% if l.actividades.all %}
                              <div class="leccion-actions text-right">
                                {% for a in l.actividades.all %}
                                  <div class="mb-1">
                                    <span class="pill-actividad">
                                      {% if a.tipo == "quiz" %}
                                        <i class="material-icons">quiz</i>
                                      {% elif a.tipo == "foro" %}
                                        <i class="material-icons">forum</i>
                                      {% else %}
                                        <i class="material-icons">assignment</i>
                                      {% endif %}
                                      {{ a.titulo|truncatechars:32 }}
                                    </span>
                                  </div>

                                  <div class="mb-2">
                                    <a href="{% url 'lms:actividad_detalle' a.pk %}"
                                       class="btn btn-sm btn-outline-info">
                                      <i class="material-icons align-middle" style="font-size:18px;">play_circle_outline</i>
                                      Ir a la actividad
                                    </a>

                                    {% if es_docente %}
                                      <a href="{% url 'lms:actividad_respuestas' a.pk %}"
                                         class="btn btn-sm btn-outline-success ml-1">
                                        <i class="material-icons align-middle" style="font-size:18px;">visibility</i>
                                        Respuestas
                                      </a>
                                    {% endif %}
                                  </div>
                                {% endfor %}
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <p class="text-muted mb-0">
                        Este módulo aún no tiene lecciones configuradas.
                      </p>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% else %}
      <p class="text-muted mb-0">
        Este curso aún no tiene módulos configurados.
      </p>
    {% endif %}
  </div>
</div>

{% endblock %}
