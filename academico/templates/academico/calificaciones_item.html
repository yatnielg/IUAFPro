{% extends "panel/grafico.html" %}
{% load static %}

{% block main_content %}

<style>
  /* ======= Reutilizamos estilos base del ejemplo 1 ======= */
  .order-img{width:34px;height:34px;object-fit:cover;border-radius:5px;margin-right:2px;background:#f7f8fa;transition:transform .2s;cursor:pointer}
  .order-img:hover{transform:scale(2.5) translateX(5px);z-index:2;box-shadow:0 4px 16px rgba(0,0,0,.18)}
  .table-responsive{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}

  /* Toolbar en columna: botón arriba, filtros abajo */
  .toolbar{ display:flex; flex-direction:column; align-items:flex-start; gap:.5rem; margin-bottom:.5rem; }
  .filters-row{ display:flex; flex-wrap:wrap; gap:.5rem; width:100%; }
  .selectpicker, .range-input { min-width:220px; max-width:280px; }

  /* ======= Layout específico ======= */
  .calif-wrap{ display:flex; flex-direction:column; gap:1rem; }
  .calif-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
  .calif-header h4{ margin:0; font-weight:600; color:#fff; }              /* <- blanco */

  .card { border-radius:12px; }
  .card-header.card-header-primary{ display:flex; align-items:center; min-height:3.25rem; overflow:visible; } /* <- deja ver icono */
  .card-header .card-title{ margin:0; font-weight:600; color:#fff; }      /* <- blanco */

  /* Pastilla del icono (evita corte y centra) */
  .card-header.card-header-icon .card-icon{
    display:flex; align-items:center; justify-content:center;
    border-radius:8px; padding:14px;
    margin-top:-20px; margin-left:15px;
    position:relative; z-index:2;
  }
  .card-header.card-header-icon .card-icon i{ font-size:32px; line-height:1; color:#fff; }

  .table.align-middle td, .table.align-middle th{ vertical-align:middle; }
  .table-sm td, .table-sm th{ padding:.55rem .75rem; }

  /* Encabezado sticky */
  .table thead th{
    position:sticky; top:0; z-index:2;
 
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.05);
  }
  .table.table-striped tbody tr:nth-of-type(odd){ background-color: rgba(0,0,0,.02); }

  /* Inputs del formset */
  .table .form-control{ height: calc(2.1rem + 2px); padding:.25rem .5rem; font-size:.95rem; line-height:1.25; }
  .table input[type="number"]{ text-align:right; }
  .table textarea.form-control{ min-height:2.1rem; }
  .table .text-danger.small{ margin-top:.15rem; }
  .calif-actions{ text-align:right; }

  .is-readonly{ background:rgba(0,0,0,.04)!important; pointer-events:none; }
  .is-readonly-input{ color:inherit; }

  /* Tema oscuro: que se vea el "Search" de DataTables */
  .dataTables_wrapper .dataTables_filter label{ color:#fff; }             /* texto “Search:” */
  .dataTables_wrapper .dataTables_filter input{
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
    color:#fff; padding:.3rem .5rem; border-radius:.375rem;
  }
  .dataTables_wrapper .dataTables_info{ color:#fff; }
  .dataTables_wrapper .dataTables_paginate .paginate_button{ color:#fff !important; }

  /* Placeholder claro */
  ::placeholder{ color:rgba(255,255,255,.7); opacity:1; }

  @media (max-width: 576px){
    .table thead th:nth-child(1){ min-width:130px; }
    .table thead th:nth-child(3){ min-width:130px; }
    .table thead th:nth-child(4){ min-width:220px; }
  }
</style>

<div class="container-fluid calif-wrap">

  <div class="calif-header">
    <h4>
      {{ listado.programa.codigo }} · {{ listado.nombre }} — {{ item.materia.codigo }} {{ item.materia.nombre }}
    </h4>
    <a class="btn btn-outline-info" href="{% url 'academico:listado_detalle' listado.pk %}">
      &larr; Volver
    </a>
  </div>

  <div class="card">
    <div class="card-header card-header-primary card-header-icon">
      <div class="card-icon"><i class="material-icons">grading</i></div>
      <h5 class="card-title mb-0">Captura de calificaciones</h5>
    </div>

    <div class="card-body">

      <!-- ======= Toolbar con filtros ======= -->
      <div class="toolbar">
        <div class="filters-row">
          <select id="filter-captura" class="selectpicker" data-style="select-with-transition" multiple title="CAPTURA">
            <option>Con nota</option>
            <option>Sin nota</option>
          </select>

          <select id="filter-observaciones" class="selectpicker" data-style="select-with-transition" multiple title="OBSERVACIONES">
            <option>Con observaciones</option>
            <option>Sin observaciones</option>
          </select>

          <input id="nota-min" type="number" step="0.01" class="form-control range-input" placeholder="Nota mínima">
          <input id="nota-max" type="number" step="0.01" class="form-control range-input" placeholder="Nota máxima">

          <button id="clear-filters" type="button" class="btn btn-sm btn-outline-warning">LIMPIAR</button>
        </div>
      </div>

      <form method="post">
  {% csrf_token %}
  {{ formset.management_form }}  {# <-- aquí, antes de la tabla #}

  <div class="table-responsive material-datatables">
    <table id="datatables-calif" class="table table-sm table-striped align-middle table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
      <thead>
        <tr>
          <th style="width:140px;">No. Estudiante</th>
          <th>Alumno</th>
          <th style="width:150px;">Profesor</th>
          <th style="width:130px;">Fecha</th>
          <th style="width:120px;">Nota</th>
          <th>Observaciones</th>
        </tr>
      </thead>
      <tbody>
        {% for form in formset %}
          {% with cal=form.instance %}
          <tr>
            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
            <td>{{ cal.alumno.numero_estudiante }}</td>
            <td>{{ cal.alumno.apellido_p }} {{ cal.alumno.apellido_m }}, {{ cal.alumno.nombre }}</td>

            <td>
              {{ form.profesor }}
              {% for e in form.profesor.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </td>
<td>
  {{ form.fecha }}
  {% for e in form.fecha.errors %}
    <div class="text-danger small">{{ e }}</div>
  {% endfor %}
</td>


            <td>
              {{ form.nota }}
              {% for e in form.nota.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </td>
            <td>
              {{ form.observaciones }}
              {% for e in form.observaciones.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr><td colspan="4" class="text-center text-muted">No hay alumnos inscritos en este listado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="calif-actions">
    <button class="btn btn-primary" type="submit">Guardar calificaciones</button>
  </div>
</form>

    </div>
  </div>

</div>

<!-- ======= DataTables ======= -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  // Normaliza inputs del formset (tipo y clases)
  document.querySelectorAll('input[name$="-nota"]').forEach(function(i){
    i.type='number'; i.step='0.01'; i.min='0'; i.max='100'; i.inputMode='decimal';
    i.classList.add('form-control');
  });
  document.querySelectorAll('textarea[name$="-observaciones"]').forEach(function(t){
    t.classList.add('form-control');
  });

  $(function () {
    const table = $('#datatables-calif').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json', emptyTable: 'Sin resultados' },
      order: [],
      paging: false,
      autoWidth: false
    });

    const $selCaptura = $('#filter-captura');
    const $selObs = $('#filter-observaciones');
    const $notaMin = $('#nota-min');
    const $notaMax = $('#nota-max');

    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
      if (settings.nTable.id !== 'datatables-calif') return true;

      const $row = $(table.row(dataIndex).node());
      const $input = $row.find('input[name$="-nota"]');
      const val = $input.val();
      const nota = val === '' ? NaN : parseFloat(val);

      const min = parseFloat($notaMin.val());
      const max = parseFloat($notaMax.val());

      let okRange = true;
      if (!isNaN(min) && (isNaN(nota) || nota < min)) okRange = false;
      if (!isNaN(max) && (isNaN(nota) || nota > max)) okRange = false;

      const capSel = $selCaptura.val() || [];
      let okCaptura = true;
      if (capSel.length) {
        const tieneNota = !isNaN(nota);
        const pideCon = capSel.includes('Con nota');
        const pideSin = capSel.includes('Sin nota');
        okCaptura = (tieneNota && pideCon) || (!tieneNota && pideSin) || (pideCon && pideSin);
      }

      const obsSel = $selObs.val() || [];
      let okObs = true;
      if (obsSel.length) {
        const $tx = $row.find('textarea[name$="-observaciones"]');
        const tieneObs = ($tx.val() || '').trim().length > 0;
        const pideCon = obsSel.includes('Con observaciones');
        const pideSin = obsSel.includes('Sin observaciones');
        okObs = (tieneObs && pideCon) || (!tieneObs && pideSin) || (pideCon && pideSin);
      }

      return okRange && okCaptura && okObs;
    });

    function refiltrar(){ table.draw(); }
    $selCaptura.on('change', refiltrar);
    $selObs.on('change', refiltrar);
    $notaMin.on('input', refiltrar);
    $notaMax.on('input', refiltrar);
    // Redibuja solo cuando el campo pierde el foco o confirman con Enter
    $('#datatables-calif').on(
      'change',
      'input[name$="-nota"], textarea[name$="-observaciones"]',
      function(){ table.draw(false); }
    );


    $('#clear-filters').on('click', function () {
      $selCaptura.val([]); $selObs.val([]); $notaMin.val(''); $notaMax.val('');
      table.search('').columns().search('');
      table.draw();
    });
  });
</script>

<script>
  document.querySelectorAll('input[name$="-nota"]').forEach(function(i){
  i.type='number'; i.step='0.01'; i.min='0'; i.max='10'; i.inputMode='decimal';
  i.classList.add('form-control');
});

document.querySelectorAll('textarea[name$="-observaciones"]').forEach(function(t){
  t.classList.add('form-control');
});

document.querySelectorAll('select[name$="-profesor"]').forEach(function(s){
  s.classList.add('form-control');
});

document.querySelectorAll('input[name$="-fecha"]').forEach(function(i){
  i.type='date';
  i.classList.add('form-control');
});
</script>


{% endblock %}
