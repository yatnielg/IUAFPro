{% extends "panel/grafico.html" %}
{% load static %}

{% block main_content %}

<style>
  .order-img{width:34px;height:34px;object-fit:cover;border-radius:5px;margin-right:2px;background:#f7f8fa;transition:transform .2s;cursor:pointer}
  .order-img:hover{transform:scale(2.5) translateX(5px);z-index:2;box-shadow:0 4px 16px rgba(0,0,0,.18)}
  .table-responsive{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}

  .toolbar{ display:flex; flex-direction:column; align-items:flex-start; gap:.5rem; margin-bottom:.5rem; }
  .filters-row{ display:flex; flex-wrap:wrap; gap:.5rem; width:100%; }
  .selectpicker, .range-input { min-width:220px; max-width:280px; }

  .calif-wrap{ display:flex; flex-direction:column; gap:1rem; }
  .calif-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; flex-wrap:wrap; }
  .calif-header h4{ margin:0; font-weight:600; color:#fff; }

  .card { border-radius:12px; }
  .card-header.card-header-primary{ display:flex; align-items:center; min-height:3.25rem; overflow:visible; }
  .card-header .card-title{ margin:0; font-weight:600; color:#fff; }

  .card-header.card-header-icon .card-icon{
    display:flex; align-items:center; justify-content:center;
    border-radius:8px; padding:14px;
    margin-top:-20px; margin-left:15px;
    position:relative; z-index:2;
  }
  .card-header.card-header-icon .card-icon i{ font-size:32px; line-height:1; color:#fff; }

  .table.align-middle td, .table.align-middle th{ vertical-align:middle; }
  .table-sm td, .table-sm th{ padding:.55rem .75rem; }

  .table thead th{
    position:sticky; top:0; z-index:2;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.05);
  }
  .table.table-striped tbody tr:nth-of-type(odd){ background-color: rgba(0,0,0,.02); }

  .table .badge{ font-size:.75rem; padding:.25rem .45rem; }
  .badge-soft-success{ background:rgba(76,175,80,.12); color:#4caf50; }
  .badge-soft-secondary{ background:rgba(158,158,158,.15); color:#b0bec5; }
  .badge-soft-warning{ background:rgba(255,193,7,.15); color:#ffc107; }

  .dataTables_wrapper .dataTables_filter label{ color:#fff; }
  .dataTables_wrapper .dataTables_filter input{
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2);
    color:#fff; padding:.3rem .5rem; border-radius:.375rem;
  }
  .dataTables_wrapper .dataTables_info{ color:#fff; }
  .dataTables_wrapper .dataTables_paginate .paginate_button{ color:#fff !important; }

  ::placeholder{ color:rgba(255,255,255,.7); opacity:1; }

  @media (max-width: 576px){
    .table thead th:nth-child(1){ min-width:100px; }
    .table thead th:nth-child(2){ min-width:140px; }
    .table thead th:nth-child(3){ min-width:200px; }
  }
</style>

<div class="container-fluid calif-wrap">

  <div class="calif-header d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0 text-white">Materias y profesores titulares</h4>
    <a class="btn btn-outline-info" href="{% url 'academico:listados_list' %}">
      &larr; Volver
    </a>
  </div>


  <div class="card">
    <div class="card-header card-header-primary card-header-icon">
      <div class="card-icon"><i class="material-icons">school</i></div>
      <h5 class="card-title mb-0">Listado de materias</h5>
    </div>

    <div class="card-body">

      <!-- ======= Toolbar / filtros ======= -->
      <div class="toolbar">
        <div class="filters-row">
          <!-- Filtro por programa -->
          <select id="filter-programa" class="selectpicker" data-style="select-with-transition" title="Programa">
            <option value="">Todos los programas</option>
            {% for codigo, nombre in programas %}
              <option value="{{ codigo }}">{{ codigo }} — {{ nombre }}</option>
            {% endfor %}
          </select>

          <!-- Filtro por titular -->
          <select id="filter-titular" class="selectpicker" data-style="select-with-transition" title="Profesor titular">
            <option value="">Todos</option>
            <option value="1">Con titular</option>
            <option value="0">Sin titular</option>
          </select>

          <!-- Buscador rápido extra (por si quieres filtrar por texto adicional) -->
          <input id="filter-texto" type="text" class="form-control range-input" placeholder="Buscar materia/profesor...">
        </div>
      </div>

      <div class="table-responsive material-datatables">
        <table id="datatables-materias" class="table table-sm table-striped align-middle table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
          <thead>
            <tr>
              <th style="width:110px;">Programa</th>
              <th style="width:110px;">Código</th>
              <th>Materia</th>
              <th style="width:220px;">Profesor titular</th>
              <th style="width:120px;"># Profesores</th>
              <th style="width:120px;"># Listados</th>
            </tr>
          </thead>
          <tbody>
            {% for m in materias %}
              {% with titular=m.profesor_titular %}
              <tr
                data-programa="{{ m.programa.codigo }}"
                data-titular="{% if titular %}1{% else %}0{% endif %}"
              >
                <td>{{ m.programa.codigo }}</td>
                <td>{{ m.codigo }}</td>
                <td>{{ m.nombre }}</td>
                <td>
                  {% if titular %}
                    {{ titular.apellido_p }} {{ titular.apellido_m }}, {{ titular.nombre }}<br>
                    {% if titular.especialidad %}
                      <span class="badge badge-soft-secondary">{{ titular.especialidad }}</span>
                    {% endif %}
                    {% if titular.ciudad %}
                      <span class="badge badge-soft-warning">{{ titular.ciudad }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge-soft-warning">Sin titular asignado</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-soft-success">{{ m.num_profesores }}</span>
                </td>
                <td>
                  <span class="badge badge-soft-secondary">{{ m.num_listados }}</span>
                </td>
              </tr>
              {% endwith %}
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">
                  No hay materias registradas.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>

<!-- ======= DataTables ======= -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
  $(function () {
    const table = $('#datatables-materias').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json', emptyTable: 'Sin resultados' },
      order: [[0, 'asc'], [1, 'asc']],
      paging: true,
      pageLength: 25,
      autoWidth: false
    });

    const $selPrograma = $('#filter-programa');
    const $selTitular = $('#filter-titular');
    const $txtFiltro  = $('#filter-texto');

    // Filtro custom por programa y titular
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
      if (settings.nTable.id !== 'datatables-materias') return true;

      const row     = table.row(dataIndex).node();
      const $row    = $(row);
      const progRow = $row.data('programa') || '';
      const titRow  = String($row.data('titular') || '');

      const progSel = $selPrograma.val() || '';
      const titSel  = $selTitular.val() || '';

      // Programa
      if (progSel && progRow !== progSel) return false;

      // Titular (1 = con, 0 = sin)
      if (titSel && titRow !== titSel) return false;

      return true;
    });

    function refiltrar(){
      table.draw();
    }

    $selPrograma.on('change', refiltrar);
    $selTitular.on('change', refiltrar);

    // Búsqueda por texto (materia/profesor)
    $txtFiltro.on('input', function(){
      table.search(this.value).draw();
    });
  });
</script>

{% endblock %}
