{% extends "panel/grafico.html" %}
{% load i18n %}

{% block title %}Alumno {{ alumno.numero_estudiante }} — CampusIUAF{% endblock %}

{% block main_content %}

<!-- DataTables (solo para la tabla de pagos) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
  .section-title {
    font-size: .95rem; letter-spacing:.06em; text-transform:uppercase;
    color: #9aa0a6; margin: 1.25rem 0 .5rem; display:flex; align-items:center; gap:.5rem;
  }
  .section-title .material-icons { font-size: 1.1rem; }
  .table-responsive { overflow-x:auto; }
  .card-header-actions {
    margin-left:auto; display:flex; gap:.5rem; align-items:center;
  }
  .doc-count-badge{
    display:inline-flex; align-items:center; gap:.35rem;
    background:rgba(0,0,0,.06); color:#5f6368; border-radius:999px;
    padding:.25rem .6rem; font-size:.85rem;
  }
  .doc-count-badge .material-icons{ font-size:1rem; }
  .mt-0 { margin-top:0!important; }
  .card-compact .card-header{ padding-top:.6rem; padding-bottom:.6rem; }
  .tag-missing { opacity:.6 }
</style>

<div class="d-flex justify-content-between align-items-center">
  <h1 class="h4 m-0 text-white">
    <i class="material-icons align-middle mr-1">person</i>
    Alumno {{ alumno.numero_estudiante }}
  </h1>

  <div class="btn-group">
    <a class="btn btn-outline-secondary" href="{% url 'estudiantes' %}">
      <i class="material-icons align-middle">arrow_back</i> Volver
    </a>

    {% if request.user.is_superuser or request.user.profile and request.user.profile.puede_editar_todo %}
    <a class="btn btn-primary" href="{% url 'alumnos_editar' alumno.pk %}">
      <i class="material-icons align-middle">edit</i> Editar
    </a>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header card-header-primary card-header-icon d-flex align-items-center">
    <div class="card-icon" title="Admisiones {{ alumno.created_by }}"><i class="material-icons">badge</i></div>
    <div>
      <h4 class="card-title m-0">Ficha del alumno</h4>
      <p class="card-category m-0">Resumen general</p>
    </div>

    <div class="card-header-actions mt-0 ml-auto d-flex align-items-center">
      {% if docs_total %}
        <span class="doc-count-badge" title="Documentos cargados">
          <i class="material-icons">attach_file</i>
          {{ docs_total }} Documento{{ docs_total|pluralize:"s" }}
        </span>
        {% if docs_last_update %}
          <span class="doc-count-badge" title="Última actualización">
            <i class="material-icons">update</i>
            {{ docs_last_update|date:"d/m/Y H:i" }}
          </span>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <div class="card-body">
    <div class="row">
      <!-- Columna izquierda -->
      <div class="col-md-6">
        <div class="section-title"><i class="material-icons">account_circle</i> Datos personales</div>
        <div class="row">
          <div class="col-sm-6 mb-3">
            <div class="text-muted small">Número de estudiante</div>
            <div class="font-weight-bold">{{ alumno.numero_estudiante }}</div>
          </div>
          <div class="col-sm-6 mb-3">
            <div class="text-muted small">CURP</div>
            <div>{{ alumno.curp|default:"—" }}</div>
          </div>

          <div class="col-sm-6 mb-3">
            <div class="text-muted small">Nombre(s)</div>
            <div class="font-weight-bold">{{ alumno.nombre }}</div>
          </div>
          <div class="col-sm-3 mb-3">
            <div class="text-muted small">Ap. paterno</div>
            <div>{{ alumno.apellido_p|default:"—" }}</div>
          </div>
          <div class="col-sm-3 mb-3">
            <div class="text-muted small">Ap. materno</div>
            <div>{{ alumno.apellido_m|default:"—" }}</div>
          </div>

          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Sexo</div>
            <div>{{ alumno.sexo|default:"—" }}</div>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Fecha de nacimiento</div>
            <div>{% if alumno.fecha_nacimiento %}{{ alumno.fecha_nacimiento|date:"d/m/Y" }}{% else %}—{% endif %}</div>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Fecha de alta</div>
            <div>
              {% if alumno.informacionEscolar and alumno.informacionEscolar.fecha_alta %}
                {{ alumno.informacionEscolar.fecha_alta|date:"d/m/Y H:i" }}
              {% else %}—{% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col-md-6">
        <div class="section-title"><i class="material-icons">contact_mail</i> Contacto & estado</div>
        <div class="row">
          <div class="col-sm-6 mb-3">
            <div class="text-muted small">Email personal</div>
            <div>
              {% if alumno.email %}
                <a href="mailto:{{ alumno.email }}">{{ alumno.email }}</a>
              {% else %}—{% endif %}
            </div>
          </div>
          <div class="col-sm-6 mb-3">
            <div class="text-muted small">Email institucional</div>
            <div>
              {% if alumno.email_institucional %}
                <a href="mailto:{{ alumno.email_institucional }}">{{ alumno.email_institucional }}</a>
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-6 mb-3">
            <div class="text-muted small">Teléfono</div>
            <div>{{ alumno.telefono|default:"—" }}</div>
          </div>

          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Estatus (general)</div>
            <span class="badge badge-secondary">{{ alumno.estatus|default:"—" }}</span>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Académico</div>
            <span class="badge badge-info">
              {% if alumno.informacionEscolar %}{{ alumno.informacionEscolar.estatus_academico|default:"—" }}{% else %}—{% endif %}
            </span>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Administrativo</div>
            <span class="badge badge-warning text-dark">
              {% if alumno.informacionEscolar %}{{ alumno.informacionEscolar.estatus_administrativo|default:"—" }}{% else %}—{% endif %}
            </span>
          </div>

          <div class="col-sm-12 mb-2">
            <div class="text-muted small">Usuario vinculado</div>
            <div>
              {% if alumno.user %}
                <i class="material-icons align-middle mr-1">person</i>
                {{ alumno.user.username }}
                {% if alumno.user.get_full_name %} ({{ alumno.user.get_full_name }}){% endif %}
              {% else %}
                <span class="text-muted">Sin usuario</span>
                — <a href="{% url 'alumnos_crear_usuario' alumno.pk %}" class="text-primary">Crear usuario</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /row -->

    <hr class="my-3">

    <div class="row">
      <div class="col-md-6">
        <div class="section-title"><i class="material-icons">school</i> Programa / Ubicación</div>
        <div class="row">
          <div class="col-sm-12 mb-3">
            <div class="text-muted small">Programa</div>
            <div>
              {% if alumno.informacionEscolar and alumno.informacionEscolar.programa %}
                {{ alumno.informacionEscolar.programa.codigo }} — {{ alumno.informacionEscolar.programa.nombre }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </div>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">País</div>
            <div>{{ alumno.pais.nombre|default:"—" }}</div>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Estado / Provincia</div>
            <div>{% if alumno.estado %}{{ alumno.estado.nombre }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
          </div>
          <div class="col-sm-4 mb-3">
            <div class="text-muted small">Sede</div>
            <div>
              {% if alumno.informacionEscolar and alumno.informacionEscolar.sede %}
                {{ alumno.informacionEscolar.sede }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="section-title"><i class="material-icons">payments</i> Plan financiero</div>
        <div class="row">
          <div class="col-sm-12 mb-2">
            <div class="text-muted small">Financiamiento</div>
            <div>
              {% if alumno.informacionEscolar and alumno.informacionEscolar.financiamiento %}
                {{ alumno.informacionEscolar.financiamiento.beca }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Inscripción</div>
            <div>
              {% if alumno.informacionEscolar %}
                $ {{ alumno.informacionEscolar.precio_inscripcion|default:"0.00" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Reinscripciones (#)</div>
            <div>
              {% if alumno.informacionEscolar %}
                {{ alumno.informacionEscolar.numero_reinscripciones|default:"0" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Colegiatura</div>
            <div>
              {% if alumno.informacionEscolar %}
                $ {{ alumno.informacionEscolar.precio_colegiatura|default:"0.00" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Descuento</div>
            <div>
              {% if alumno.informacionEscolar %}
                $ {{ alumno.informacionEscolar.monto_descuento|default:"0.00" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Precio final</div>
            <div>
              {% if alumno.informacionEscolar %}
                $ {{ alumno.informacionEscolar.precio_final|default:"0.00" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-4 mb-2">
            <div class="text-muted small">Meses del programa</div>
            <div>
              {% if alumno.informacionEscolar %}
                {{ alumno.informacionEscolar.meses_programa|default:"—" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-6 mb-2">
            <div class="text-muted small">Precio de equivalencia</div>
            <div>
              {% if alumno.informacionEscolar %}
                {% with pe=alumno.informacionEscolar.precio_equivalencia %}
                  {% if pe and pe|stringformat:"s" != "-1.00" %}
                    $ {{ pe }}
                  {% else %}
                    <span class="text-muted">No aplica</span>
                  {% endif %}
                {% endwith %}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-6 mb-2">
            <div class="text-muted small">Precio de titulación</div>
            <div>
              {% if alumno.informacionEscolar %}
                $ {{ alumno.informacionEscolar.precio_titulacion|default:"0.00" }}
              {% else %}—{% endif %}
            </div>
          </div>

          <div class="col-sm-6 mb-2">
            <div class="text-muted small">Inicio del programa</div>
            <div>
              {% if alumno.informacionEscolar and alumno.informacionEscolar.inicio_programa %}
                {{ alumno.informacionEscolar.inicio_programa|date:"d/m/Y" }}
              {% else %}—{% endif %}
            </div>
          </div>

<div class="col-sm-6 mb-2">
  <div class="text-muted small">Fin del programa</div>
  <div>
    {% if alumno.informacionEscolar and alumno.informacionEscolar.fin_programa %}
      <span class="{% if fin_programa_is_future %}text-success font-weight-bold{% endif %}">
        {{ alumno.informacionEscolar.fin_programa|date:"d/m/Y" }}
      </span>
    {% else %}—{% endif %}
  </div>
</div>

          <div class="col-sm-12 mb-2">
            <div class="text-muted small">¿Requiere datos de facturación?</div>
            <div>
              {% if alumno.informacionEscolar %}
                {% if alumno.informacionEscolar.requiere_datos_de_facturacion %}
                  <span class="badge badge-danger">Sí</span>
                {% else %}
                  <span class="badge badge-success">No</span>
                {% endif %}
              {% else %}—{% endif %}
            </div>
          </div>
        </div>
      </div>
    </div> <!-- /row detalles -->
  </div>
</div>

{% if can_view_pagos %}
<!-- ===================== PAGOS DEL ALUMNO ===================== -->
<div class="card mt-4">
  <div class="card-header card-header-primary card-header-icon">
    <div class="card-icon"><i class="material-icons">receipt_long</i></div>
    <h4 class="card-title">Pagos del alumno (DIARIO)</h4>
    <p class="card-category">
      Total registros: <strong>{{ pagos|length }}</strong>
      &nbsp;•&nbsp; Suma de montos: <strong>$ {{ pagos_total }} </strong>
    </p>
  </div>

  <div class="card-body">


   <div class="d-flex justify-content-between mb-2">
  <div class="small text-muted">
    Los pagos se importan desde el Excel “DIARIO”. Si alguno falta, verifica la importación.
  </div>

  <div class="d-flex gap-2">
    {% if request.user.is_superuser %}
      <a class="btn btn-outline-secondary btn-sm"
         href="/admin/alumnos/pagodiario/?alumno__id__exact={{ alumno.id }}" target="_blank">
        Ver en Admin
      </a>
    {% endif %}

    {# 👉 Botón que abre el Estado de cuenta para este alumno #}
<a class="btn btn-primary btn-sm d-inline-flex align-items-center descargar-estado-cuenta"
   href="{% url 'estado_cuenta' alumno.numero_estudiante %}"
   data-url="{% url 'estado_cuenta' alumno.numero_estudiante %}"
   target="_blank" rel="noopener"
   title="Generar PDF del estado de cuenta">
  <i class="material-icons align-middle me-1">picture_as_pdf</i>
  Estado de cuenta
</a>

  </div>
</div>



    <div class="table-responsive">
      <table id="tabla-pagos" class="table table-striped table-hover" width="100%">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Folio</th>
            <th>Monto</th>
            <th>Concepto</th>
            <th>Detalle</th>
            <th>Programa</th>
            <th>Forma</th>
            <th>Sede</th>
            <th>CURP</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for p in pagos %}
          <tr>
            <td title="{% if p.creado_en %}{{ p.creado_en|date:"d/m/Y" }}{% else %}—{% endif %}" data-order="{{ p.fecha|date:'Y-m-d' }}">{% if p.fecha %}{{ p.fecha|date:"d/m/Y" }}{% else %}—{% endif %}</td>
            <td>{{ p.folio|default:"—" }}</td>
            <td>{% if p.monto != None %}$ {{ p.monto }}{% else %}—{% endif %}</td>
            <td>{{ p.concepto|default:"—" }}</td>
            <td>{{ p.pago_detalle|default:"—" }}</td>
            <td>{{ p.programa|default:"—" }}</td>
            <td>{{ p.forma_pago|default:"—" }}</td>
            <td>{{ p.sede|default:"—" }}</td>
            <td>{{ p.curp|default:"—" }}</td>

            <td class="text-right">
  <a href="/admin/alumnos/pagodiario/{{ p.pk }}/change/" class="btn btn-link text-info btn-just-icon like" title="Ver/Editar (admin)">
    <i class="material-icons">visibility</i>
  </a>
  
 {% comment %} <a href="{% url 'pago_recibo_pdf' p.pk %}" class="btn btn-outline-success btn-sm" target="_blank" title="Generar recibo (PDF)">
    <i class="material-icons align-middle">picture_as_pdf</i> Recibo
  </a>  {% endcomment %}
 

<a href="{% url 'recibo_carta' p.pk %}"
   data-url="{% url 'recibo_carta' p.pk %}"
   data-folio="{{ p.folio|default:p.pk }}"
   class="btn btn-outline-success btn-sm descargar-recibo d-inline-flex align-items-center"
   title="Generar recibo (PDF)">
  <i class="material-icons align-middle mr-1 me-1">picture_as_pdf</i>
  Recibo
</a>




</td>



          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center text-muted py-4">Este alumno no tiene pagos registrados.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<!-- ===================== CARGOS PENDIENTES ===================== -->
{% if can_view_pagos %}
<div class="card mt-4">
  <div class="card-header card-header-primary card-header-icon">
    <div class="card-icon"><i class="material-icons">shopping_cart</i></div>
    <h4 class="card-title">Cargos del alumno</h4>
    <p class="card-category">
      Pendientes: <strong>{{ cargos_pendientes|length }}</strong>      
    </p>


<div class="ml-auto">
    <button
      id="btnGenerarCargos"
      class="btn btn-outline-primary btn-sm d-inline-flex align-items-center"
      data-url="{% url 'generar_cargos_mensuales' alumno.numero_estudiante %}"
      title="Generar cargos mensuales (día 6 por {{ alumno.informacionEscolar.meses_programa|default:'0' }} meses)"
    >
      <i class="material-icons align-middle mr-1">playlist_add</i>
      Generar cargos mensuales
    </button>
  </div>




  </div>


  <div class="card-body table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Concepto</th>
          <th class="text-right">Monto</th>
          <th>Vence</th>
          <th>Estado</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
{% for c in cargos %}
<tr class="{% if c.is_overdue %}{% endif %}">
  <td>{{ c.fecha_cargo|date:"d/m/Y" }}</td>
  <td>{{ c.concepto.nombre }}</td>
  <td class="text-right">$ {{ c.monto }}</td>

  {# Fecha de vencimiento (o fallback) con resaltado si está vencido #}
  <td>
    {% if c.fecha_vencimiento %}
      <span class="{% if c.is_overdue %}text-danger font-weight-bold{% endif %}">
        {{ c.fecha_vencimiento|date:"d/m/Y" }}
      </span>
    {% else %}
      <span class="{% if c.is_overdue %}text-danger font-weight-bold{% endif %}">
        {{ c.fecha_cargo|date:"d/m/Y" }}
      </span>
    {% endif %}
    {% if c.is_overdue %}
      <span class="badge badge-danger ml-1">Vencido</span>
    {% endif %}
  </td>

  <td>
    {% if c.pagado %}
      <span class="badge badge-success">Pagado</span>
    {% else %}
      <span class="badge badge-warning text-dark">Pendiente</span>
    {% endif %}
  </td>

{% if request.user.is_superuser %}
  <td class="text-right">
    {% if not c.pagado %}
      <a class="btn btn-primary btn-sm" href="{% url 'clip_crear_pago_cargo' c.id %}">
        Pagar con tarjeta (Clip)
      </a>
    {% endif %}
  </td>
{% else %}
  <td></td>
{% endif %}

</tr>
{% empty %}
<tr><td colspan="6" class="text-center text-muted">Sin cargos.</td></tr>
{% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if can_view_documentos %}
<!-- ===================== DOCUMENTOS DINÁMICOS (solo lectura) ===================== -->
<div class="card mt-4">
  <div class="card-header card-header-primary card-header-icon d-flex align-items-center">
    <div class="card-icon"><i class="material-icons">folder_open</i></div>
    <div>
      <h4 class="card-title m-0">Documentos del alumno (solo lectura)</h4>
      <p class="card-category m-0">
        {% if alumno.informacionEscolar and alumno.informacionEscolar.programa %}
          Requisitos para el programa: <strong>{{ alumno.informacionEscolar.programa.codigo }}</strong>
          {% if docs_total %}&nbsp;•&nbsp; Cargados: <strong>{{ docs_total }}</strong>{% endif %}
          {% if docs_last_update %}&nbsp;•&nbsp; Última actualización: <strong>{{ docs_last_update|date:"d/m/Y H:i" }}</strong>{% endif %}
        {% else %}
          El alumno no tiene un programa asignado.
        {% endif %}
      </p>
    </div>

    <div class="card-header-actions ml-auto mt-0">
      {% if alumno and alumno.pk %}
        <a class="btn btn-outline-primary" href="{% url 'alumnos_documentos_pdf' alumno.pk %}" target="_blank" rel="noopener">
          Unificar en PDF
        </a>
      {% endif %}
    </div>
  </div>

  <div class="card-body">
    {% if not alumno.informacionEscolar or not alumno.informacionEscolar.programa %}
      <div class="text-muted">No hay requisitos porque el alumno no tiene programa.</div>
    {% else %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th style="width:34%">Documento (tipo)</th>
              <th style="width:46%">Archivo</th>
              <th style="width:8%">Válido</th>
              <th style="width:12%">Verificado</th>
            </tr>
          </thead>
          <tbody>
            {% for d in docs %}
            <tr>
              <td>
                {{ d.tipo.nombre }}
                {% if not d.valido %}<span class="badge badge-warning text-dark ml-1">Por validar</span>{% endif %}
              </td>
              <td>
                {% if d.archivo %}
                  <a class="btn btn-link p-0" href="{{ d.archivo.url }}" target="_blank" rel="noopener">
                    <i class="material-icons align-middle">open_in_new</i> Abrir
                  </a>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if d.valido %}
                  <span class="badge badge-success">Sí</span>
                {% else %}
                  <span class="badge badge-secondary">No</span>
                {% endif %}
              </td>
              <td>
                {% if d.verificado_por %}
                  {{ d.verificado_por }}<br>
                  {% if d.verificado_en %}<small class="text-muted">{{ d.verificado_en|date:"d/m/Y H:i" }}</small>{% endif %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-muted">Aún no hay documentos cargados.</td>
            </tr>
            {% endfor %}

            {% if faltantes %}
              <tr>
                <td colspan="4">
                  <div class="mt-2">
                    <strong>Faltantes:</strong>
                    {% for t in faltantes %}
                      <span class="badge badge-light tag-missing">{{ t.nombre }}</span>
                    {% endfor %}
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="text-right">
        {% if request.user.is_superuser or request.user.profile and request.user.profile.puede_editar_todo %}
        <a class="btn btn-outline-info" href="{% url 'alumnos_documentos_editar' alumno.pk %}">
          <i class="material-icons align-middle">upload_file</i> Subir/actualizar documentos
        </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<script>
  $(function(){
    var $tabla = $('#tabla-pagos');
    if ($tabla.length) {
      $tabla.DataTable({
        language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
        order: [[0, 'desc']],   // 👈 más reciente primero
        pageLength: 10,
        autoWidth: false,
        scrollX: true
      });
    }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>


<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.descargar-recibo');
  if (!btn) return;
  e.preventDefault();

  try {
    const url = btn.getAttribute('data-url') || btn.getAttribute('href');
    const resp = await fetch(url, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('No se pudo cargar el recibo');
    const html = await resp.text();

    const cont = document.createElement('div');
    cont.style.position = 'fixed';
    cont.style.left = '-99999px';
    cont.style.top = '0';
    cont.style.width = '850px';
    cont.innerHTML = html;
    document.body.appendChild(cont);

    const style = document.createElement('style');
    style.textContent = `
      @page { size: Letter; margin: 0 !important; }
      html, body { background:#fff !important; margin:0 !important; padding:0 !important; }
      .sheet { width:8.5in !important; min-height:auto !important; margin:0 !important; box-shadow:none !important; border:none !important; }
      .doc { padding:0.5in !important; }
    `;
    (cont.querySelector('head') || cont).appendChild(style);

    const el = cont.querySelector('.sheet') || cont;

    let folio = el.querySelector('.amount-box .amount-num')?.textContent?.trim() || 'recibo';
    folio = folio.replace(/[^\w\-]+/g, '');

    await html2pdf().from(el).set({
      margin: 0,
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 }
    }).save(`recibo_${folio}.pdf`);

    cont.remove();
  } catch (err) {
    console.error(err);
    alert('No se pudo generar el PDF. Revisa la consola (F12).');
  }
});
</script>


<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.descargar-estado-cuenta');
  if (!btn) return;
  e.preventDefault();

  try {
    const url = btn.getAttribute('data-url') || btn.getAttribute('href');
    const resp = await fetch(url, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('No se pudo cargar el estado de cuenta');
    const html = await resp.text();

    // Contenedor fuera de pantalla
    const cont = document.createElement('div');
    cont.style.position = 'fixed';
    cont.style.left = '-99999px';
    cont.style.top = '0';
    cont.style.width = '850px';
    cont.innerHTML = html;
    document.body.appendChild(cont);

    // Overrides para PDF
    const style = document.createElement('style');
    style.textContent = `
      @page { size: Letter; margin: 0 !important; }
      html, body { background:#fff !important; margin:0 !important; padding:0 !important; }
      .sheet { width:8.5in !important; margin:0 !important; box-shadow:none !important; border:none !important; }
    `;
    (cont.querySelector('head') || cont).appendChild(style);

    const el = cont.querySelector('.sheet') || cont;

    // === Escalado automático a 1 página Letter ===
    const PX_PER_IN = 96;                  // densidad típica del navegador
    const pageW = 8.5 * PX_PER_IN;
    const pageH = 11  * PX_PER_IN;
    el.style.width = pageW + 'px';
    el.style.maxWidth = pageW + 'px';

    // espera un tick para que se apliquen estilos
    await new Promise(r => setTimeout(r, 50));

    const h = el.scrollHeight;
    if (h > pageH) {
      const scale = (pageH - 8) / h;       // margen de seguridad 8px
      el.style.transformOrigin = 'top left';
      el.style.transform = `scale(${scale})`;
      // fija la altura resultante para que html2canvas no agregue nueva página
      el.style.height = Math.ceil(h * scale) + 'px';
    }

    await html2pdf().from(el).set({
      margin: 0,
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['css','legacy'] },  // 👈 sin 'avoid-all'
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 }
    }).save('estado_cuenta.pdf');

    cont.remove();
  } catch (err) {
    console.error(err);
    alert('No se pudo generar el PDF del estado de cuenta. Revisa la consola (F12).');
  }
});
</script>





<script>
(function(){
  function getCookie(name){
    const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m?m.pop():'';
  }

  async function generarCargos(url){
    const csrftoken = getCookie('csrftoken');
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrftoken
      },
      body: new URLSearchParams({}) // aquí puedes enviar 'concepto_id' si quieres
    });
    if (!resp.ok) {
      const txt = await resp.text().catch(()=> '');
      throw new Error(txt || ('HTTP '+resp.status));
    }
    return resp.json();
  }

  document.getElementById('btnGenerarCargos')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const url = e.currentTarget.getAttribute('data-url');

    // Confirmación
    const seguro = confirm('Esto generará los cargos mensuales (día 6) desde el mes de inicio del programa por todos los meses del plan. ¿Continuar?');
    if (!seguro) return;

    try {
      e.currentTarget.disabled = true;
      const data = await generarCargos(url);

      if (data.ok) {
        const msg = `Creados: ${data.creados} • Ya existían: ${data.existentes}\n` +
                    `Concepto: ${data.concepto} • Monto: $${data.monto}\n` +
                    `Desde: ${data.desde} • Meses: ${data.meses}`;
        if (window.notify) {
          notify('Cargos generados correctamente. ' + msg.replace(/\n/g, ' • '), 'success');
        } else {
          alert('Cargos generados correctamente.\n\n' + msg);
        }
        // Recarga para ver la tabla actualizada
        window.location.reload();
      } else {
        throw new Error(data.error || 'No se pudo generar cargos.');
      }
    } catch(err) {
      console.error(err);
      if (window.notify) notify('Error: ' + err.message, 'danger');
      else alert('Error: ' + err.message);
    } finally {
      e.currentTarget.disabled = false;
    }
  });
})();
</script>




{% endblock %}
