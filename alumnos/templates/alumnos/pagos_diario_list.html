{% extends "panel/grafico.html" %}
{% load static %}

{% block main_content %}

<style>
  .order-img{ width:34px!important; height:34px!important; object-fit:cover; border-radius:5px; margin-right:2px; background:#f7f8fa; transition:transform .2s; cursor:pointer; }
  .order-img:hover{ transform:scale(2.5) translateX(5px); z-index:2; box-shadow:0 4px 16px rgba(0,0,0,.18); }
  html, body{ height:100%!important; overflow-y:auto!important; overflow-x:hidden!important; }
  .main-panel, .content, .card-body{ overflow-y:visible!important; }
  .dataTables_wrapper{ overflow-x:auto; overflow-y:visible; }
  .table-responsive{ width:100%; overflow-x:auto!important; overflow-y:visible!important; -webkit-overflow-scrolling:touch; }
</style>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<div class="content">
  <div class="toolbar">
    {% if request.user.is_staff %}
      <a href="{% url 'pagos_diario_lista' %}" class="btn btn-primary btn-sm">
        <i class="material-icons" style="vertical-align:middle">receipt_long</i>
        Pagos de Diario
      </a>
    {% endif %}
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">

        <div class="card">
          <div class="card-header card-header-primary card-header-icon">
            <div class="card-icon"><i class="material-icons">assignment</i></div>
            <h4 class="card-title">Pagos (DIARIO)</h4>
          </div>

<div class="card-body">
  <!-- Filtros simples -->
<form method="get" class="mb-3">
  <div class="form-row align-items-end">
    <!-- Fecha desde -->
    <div class="col-12 col-sm-6 col-md-3 mb-2">
      <label class="mb-1">Desde</label>
      <input type="date" name="desde" value="{{ desde }}" class="form-control form-control-sm">
    </div>

    <!-- Fecha hasta -->
    <div class="col-12 col-sm-6 col-md-3 mb-2">
      <label class="mb-1">Hasta</label>
      <input type="date" name="hasta" value="{{ hasta }}" class="form-control form-control-sm">
    </div>

    <!-- Creado desde -->
    <div class="col-12 col-sm-6 col-md-3 mb-2">
      <label class="mb-1">Creado desde</label>
      <input type="date" name="creado_desde" value="{{ creado_desde }}" class="form-control form-control-sm">
    </div>

    <!-- Creado hasta -->
    <div class="col-12 col-sm-6 col-md-3 mb-2">
      <label class="mb-1">Creado hasta</label>
      <input type="date" name="creado_hasta" value="{{ creado_hasta }}" class="form-control form-control-sm">
    </div>

    <!-- Buscar -->
    <div class="col-12 col-md-6 col-lg-4 mb-2">
      <label class="mb-1">Buscar</label>
      <input type="text" name="q" value="{{ q }}" placeholder="folio, concepto, alumno..." class="form-control form-control-sm">
    </div>

    <!-- Botones -->
    <div class="col-12 col-md-6 col-lg-4 mb-2 d-flex align-items-end">
      <button class="btn btn-primary btn-sm mr-2" type="submit">
        <i class="material-icons" style="vertical-align:middle">search</i> Filtrar
      </button>
      {% if request.GET %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'pagos_diario_lista' %}">Limpiar</a>
      {% endif %}
    </div>
  </div>
</form>

  <!-- ...tu tabla existente... -->
  <div class="material-datatables table-responsive">
    <!-- tabla existente -->
  </div>
</div>

          <div class="card-body">
            <div class="material-datatables table-responsive">
              <table id="pagos-table" class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%">
                <thead>
                  <tr>
                    <th>Folio</th>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>CURP</th>
                    <th>Programa</th>
                    <th>Concepto</th>
                    <th>Detalle</th>
                    <th>Monto</th>
                    <th>Forma de pago</th>
                    <th>Sede</th>
                    <th>Alumno</th>
                    <th class="disabled-sorting text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in pagos %}
                  <tr>
                    <td>{{ p.folio|default:"—" }}</td>
                    <td>{% if p.fecha %}{{ p.fecha|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                    <td>{{ p.nombre|default:"—" }}</td>
                    <td>{{ p.curp|default:"—" }}</td>
                    <td>{{ p.programa|default:"—" }}</td>
                    <td>{{ p.concepto|default:"—" }}</td>
                    <td>{{ p.pago_detalle|default:"—" }}</td>
                    <td>{% if p.monto != None %}$ {{ p.monto }}{% else %}—{% endif %}</td>
                    <td>{{ p.forma_pago|default:"—" }}</td>
                    <td>{{ p.sede|default:"—" }}</td>
                    <td>
                      {% if p.alumno_id %}
                        <a href="{% url 'alumnos_detalle' p.alumno_id %}">
                          {{ p.alumno.numero_estudiante }} — {{ p.alumno.nombre }}
                        </a>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>

                    <td class="text-right">
                      <a href="/admin/alumnos/pagodiario/{{ p.pk }}/change/"
                         class="btn btn-link text-info btn-just-icon like"
                         title="Ver/Editar (admin)">
                        <i class="material-icons">visibility</i>
                      </a>

                      <!-- Descargar PDF -->
                      <a href="{% url 'recibo_carta' p.pk %}"
                         data-url="{% url 'recibo_carta' p.pk %}"
                         data-folio="{{ p.folio|default:p.pk }}"
                         data-alumno="{{ p.alumno.nombre|default:p.nombre|default:'' }}"
                         class="btn btn-link text-danger btn-just-icon descargar-recibo"
                         title="Descargar recibo (PDF)">
                        <i class="material-icons">picture_as_pdf</i>
                      </a>

                      <!-- Enviar PDF por email -->
                      <a href="#"
                         class="btn btn-link text-success btn-just-icon enviar-recibo"
                         data-html-url="{% url 'recibo_carta' p.pk %}"
                         data-send-url="{% url 'enviar_recibo_con_pdf' p.pk %}"
                         data-folio="{{ p.folio|default:p.pk }}"
                         data-alumno="{{ p.alumno.nombre|default:p.nombre|default:'' }}"
                         data-email="{{ p.alumno.email|default:p.alumno.email_institucional|default:'' }}"
                         title="Enviar por email (PDF adjunto)">
                        <i class="material-icons">email</i>
                      </a>
                    </td>

                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="13" class="text-center text-muted py-4">Sin resultados</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div> <!-- /table-responsive -->
          </div> <!-- /card-body -->
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>
<script>
  $(document).ready(function() {
    $('#pagos-table').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
      order: [[1, 'desc'], [0, 'desc']],
      pageLength: 10,
      autoWidth: false,
      scrollX: true,
      scrollCollapse: true
    });
  });
</script>

<!-- Librería para generar PDF en el navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-YcsIPGmIPb2sT0l7jQRmE2Kjv0l1o8S1VgAqWg0c1c0wQdB6lq2jJm2H7nG2s5Nwz3j+u4o2o9pKp5b19+N3GQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ---------- Helpers ---------- */
function slugifyFilename(s) {
  if (!s) return '';
  return s
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // quita acentos
    .replace(/[^A-Za-z0-9\-_. ]+/g, '')              // quita caracteres raros
    .replace(/\s+/g, '_')                             // espacios -> _
    .replace(/_+/g, '_')                              // colapsa __
    .replace(/^_+|_+$/g, '')                          // bordes
    .substring(0, 150);
}

/* ---------- DESCARGAR: nombra ALUMNO_FOLIO.pdf ---------- */
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.descargar-recibo');
  if (!btn) return;
  e.preventDefault();

  try {
    const url = btn.getAttribute('data-url') || btn.getAttribute('href');
    const resp = await fetch(url, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('No se pudo cargar el recibo');
    const html = await resp.text();

    // Contenedor offscreen
    const cont = document.createElement('div');
    cont.style.position = 'fixed';
    cont.style.left = '-99999px';
    cont.style.top = '0';
    cont.style.width = '850px';
    cont.innerHTML = html;
    document.body.appendChild(cont);

    // Inyecta CSS de exportación
    const style = document.createElement('style');
    style.textContent = `
      @page { size: Letter; margin: 0 !important; }
      html, body { background: #fff !important; margin: 0 !important; padding: 0 !important; }
      .sheet { width: 8.5in !important; min-height: auto !important; margin: 0 !important;
               box-shadow: none !important; border: none !important; }
      .doc { padding: 0.5in !important; }
    `;
    (cont.querySelector('head') || cont).appendChild(style);

    const el = cont.querySelector('.sheet') || cont;

    // Obtén folio y alumno: 1) data-*, 2) <meta>, 3) fallback DOM
    let folio = btn.getAttribute('data-folio')
            || cont.querySelector('meta[name="recibo-folio"]')?.content
            || el.querySelector('.amount-box .amount-num')?.textContent?.trim()
            || 'recibo';

    let alumno = btn.getAttribute('data-alumno')
             || cont.querySelector('meta[name="recibo-alumno"]')?.content
             || 'alumno';

    folio = slugifyFilename(folio);
    alumno = slugifyFilename(alumno);

    await html2pdf().from(el).set({
      margin: 0,
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 }
    }).save(`${alumno}_${folio}.pdf`);

    cont.remove();
  } catch (err) {
    console.error(err);
    alert('No se pudo generar el PDF. Revisa la consola (F12).');
  }
});
</script>

<script>
/* ---------- ENVIAR: usa ALUMNO_FOLIO.pdf y confirmación ---------- */
async function generarContenedorDesdeHTML(url) {
  const resp = await fetch(url, { credentials: 'same-origin' });
  if (!resp.ok) throw new Error('No se pudo cargar el recibo');
  const html = await resp.text();

  const cont = document.createElement('div');
  cont.style.position = 'fixed';
  cont.style.left = '-99999px';
  cont.style.top = '0';
  cont.style.width = '850px';
  cont.innerHTML = html;

  const style = document.createElement('style');
  style.textContent = `
    @page { size: Letter; margin: 0 !important; }
    html, body { background: #fff !important; margin: 0 !important; padding: 0 !important; }
    .sheet { width: 8.5in !important; min-height: auto !important; margin: 0 !important;
             box-shadow: none !important; border: none !important; }
    .doc { padding: 0.5in !important; }
  `;
  (cont.querySelector('head') || cont).appendChild(style);

  document.body.appendChild(cont);
  const el = cont.querySelector('.sheet') || cont;
  return { cont, el };
}

async function html2pdfBlob(el) {
  const worker = html2pdf().from(el).set({
    margin: 0,
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
    html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 }
  }).toPdf();

  const pdf = await worker.get('pdf');
  const blob = pdf.output('blob');
  return blob;
}

function getCSRFToken() {
  const match = document.cookie.match(/csrftoken=([^;]+)/);
  return match ? match[1] : '';
}

async function enviarPDFalServidor(blob, sendUrl, filename) {
  const fd = new FormData();
  fd.append('recibo', blob, filename || 'recibo.pdf');

  const resp = await fetch(sendUrl, {
    method: 'POST',
    body: fd,
    credentials: 'same-origin',
    headers: { 'X-CSRFToken': getCSRFToken() },
  });
  if (!resp.ok) {
    const txt = await resp.text().catch(() => '');
    throw new Error(`Error servidor: ${resp.status} ${txt}`);
  }
  return resp.json();
}

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.enviar-recibo');
  if (!btn) return;
  e.preventDefault();

  // Confirmación previa
  const folioHint = btn.getAttribute('data-folio') || 'este recibo';
  const emailHint = btn.getAttribute('data-email') || 'el correo del alumno';
  const confirmar = window.confirm(`¿Enviar ${folioHint} por email a ${emailHint}?\n\nSe adjuntará el PDF generado.`);
  if (!confirmar) return;

  // Evitar doble clic mientras se envía
  if (btn.dataset.sending === '1') return;
  btn.dataset.sending = '1';
  const prevTitle = btn.title;
  btn.title = 'Enviando…';
  btn.classList.add('disabled');

  const htmlUrl = btn.getAttribute('data-html-url');
  const sendUrl = btn.getAttribute('data-send-url');

  try {
    // 1) Monta el HTML offscreen
    const { cont, el } = await generarContenedorDesdeHTML(htmlUrl);

    // 2) Nombre de archivo: ALUMNO_FOLIO.pdf
    let folio = btn.getAttribute('data-folio')
             || cont.querySelector('meta[name="recibo-folio"]')?.content
             || el.querySelector('.amount-box .amount-num')?.textContent?.trim()
             || 'recibo';

    let alumno = btn.getAttribute('data-alumno')
              || cont.querySelector('meta[name="recibo-alumno"]')?.content
              || 'alumno';

    folio = slugifyFilename(folio);
    alumno = slugifyFilename(alumno);
    const filename = `${alumno}_${folio}.pdf`;

    // 3) Genera BLOB del PDF
    const blob = await html2pdfBlob(el);

    // 4) Sube y envía por email
    const out = await enviarPDFalServidor(blob, sendUrl, filename);

    cont.remove();
    if (out.ok) {
      alert(out.msg || 'Correo enviado.');
    } else {
      alert(out.error || 'No se pudo enviar el correo.');
    }
  } catch (err) {
    console.error(err);
    alert('No se pudo enviar el correo. Revisa consola (F12).');
  } finally {
    // Rehabilitar botón
    btn.dataset.sending = '0';
    btn.title = prevTitle;
    btn.classList.remove('disabled');
  }
});
</script>

{% endblock %}
