{% extends "panel/grafico.html" %}
{% load static %}

{% block main_content %}

<style>
  .order-img{ width:34px!important; height:34px!important; object-fit:cover; border-radius:5px; margin-right:2px; background:#f7f8fa; transition:transform .2s; cursor:pointer; }
  .order-img:hover{ transform:scale(2.5) translateX(5px); z-index:2; box-shadow:0 4px 16px rgba(0,0,0,.18); }
  html, body{ height:100%!important; overflow-y:auto!important; overflow-x:hidden!important; }
  .main-panel, .content, .card-body{ overflow-y:visible!important; }
  .dataTables_wrapper{ overflow-x:auto; overflow-y:visible; }
  .table-responsive{ width:100%; overflow-x:auto!important; overflow-y:visible!important; -webkit-overflow-scrolling:touch; }
</style>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<div class="content">
  <div class="toolbar">
    {% if request.user.is_staff %}
      <a href="{% url 'pagos_diario_lista' %}" class="btn btn-primary btn-sm">
        <i class="material-icons" style="vertical-align:middle">receipt_long</i>
        Pagos de Diario
      </a>
    {% endif %}
  </div>

  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">

        <div class="card">
          <div class="card-header card-header-primary card-header-icon">
            <div class="card-icon"><i class="material-icons">assignment</i></div>
            <h4 class="card-title">Pagos (DIARIO)</h4>
          </div>

          <div class="card-body">
            <div class="material-datatables table-responsive">
              <table id="pagos-table" class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%">
                <thead>
                  <tr>
                    <th>Folio</th>
                    <th>Fecha</th>
                    <th>Nombre</th>
                    <th>CURP</th>
                    <th>Programa</th>
                    <th>Concepto</th>
                    <th>Detalle</th>
                    <th>Monto</th>
                    <th>Forma de pago</th>
                    <th>Sede</th>
                    <th>No.Alumno</th>
                    <th>Alumno</th>
                    <th class="disabled-sorting text-right">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for p in pagos %}
                  <tr>
                    <td>{{ p.folio|default:"—" }}</td>
                    <td>{% if p.fecha %}{{ p.fecha|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                    <td>{{ p.nombre|default:"—" }}</td>
                    <td>{{ p.curp|default:"—" }}</td>
                    <td>{{ p.programa|default:"—" }}</td>
                    <td>{{ p.concepto|default:"—" }}</td>
                    <td>{{ p.pago_detalle|default:"—" }}</td>
                    <td>{% if p.monto != None %}$ {{ p.monto }}{% else %}—{% endif %}</td>
                    <td>{{ p.forma_pago|default:"—" }}</td>
                    <td>{{ p.sede|default:"—" }}</td>
                    <td>{{ p.numero_alumno|default:"—" }}</td>
                    <td>
                      {% if p.alumno_id %}
                        <a href="{% url 'alumnos_detalle' p.alumno_id %}">
                          {{ p.alumno.numero_estudiante }} — {{ p.alumno.nombre }}
                        </a>
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>

                    <td class="text-right">
                      <a href="/admin/alumnos/pagodiario/{{ p.pk }}/change/"
                         class="btn btn-link text-info btn-just-icon like"
                         title="Ver/Editar (admin)">
                        <i class="material-icons">visibility</i>
                      </a>

                      <!-- Botón: descarga PDF en el navegador -->
                      <a href="{% url 'recibo_carta' p.pk %}"
                         data-url="{% url 'recibo_carta' p.pk %}"
                         class="btn btn-link text-danger btn-just-icon descargar-recibo"
                         title="Descargar recibo (PDF)">
                        <i class="material-icons">picture_as_pdf</i>
                      </a>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="13" class="text-center text-muted py-4">Sin resultados</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div> <!-- /table-responsive -->
          </div> <!-- /card-body -->
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>
<script>
  $(document).ready(function() {
    $('#pagos-table').DataTable({
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
      order: [[1, 'desc'], [0, 'desc']],
      pageLength: 10,
      autoWidth: false,
      scrollX: true,
      scrollCollapse: true
    });
  });
</script>

<!-- Librería para generar PDF en el navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-YcsIPGmIPb2sT0l7jQRmE2Kjv0l1o8S1VgAqWg0c1c0wQdB6lq2jJm2H7nG2s5Nwz3j+u4o2o9pKp5b19+N3GQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.descargar-recibo');
  if (!btn) return;
  e.preventDefault();

  try {
    const url = btn.getAttribute('data-url') || btn.getAttribute('href');
    const resp = await fetch(url, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('No se pudo cargar el recibo');
    const html = await resp.text();

    // Contenedor offscreen
    const cont = document.createElement('div');
    cont.style.position = 'fixed';
    cont.style.left = '-99999px';
    cont.style.top = '0';
    cont.style.width = '850px';
    cont.innerHTML = html;
    document.body.appendChild(cont);

    // Inyecta CSS de exportación para evitar páginas en blanco
    const style = document.createElement('style');
    style.textContent = `
      @page { size: Letter; margin: 0 !important; }
      html, body { background: #fff !important; margin: 0 !important; padding: 0 !important; }
      .sheet { width: 8.5in !important; min-height: auto !important; margin: 0 !important;
               box-shadow: none !important; border: none !important; }
      .doc { padding: 0.5in !important; } /* margen interno del contenido */
    `;
    // Si el HTML trae <head>, úsalo; si no, añádelo al contenedor
    (cont.querySelector('head') || cont).appendChild(style);

    const el = cont.querySelector('.sheet') || cont;

    // Nombre de archivo por folio
    let folio = el.querySelector('.amount-box .amount-num')?.textContent?.trim() || 'recibo';
    folio = folio.replace(/[^\w\-]+/g, '');

    // Generar PDF sin márgenes externos
    await html2pdf().from(el).set({
      margin: 0, // ¡importante!
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true, scrollY: 0 }
    }).save(`recibo_${folio}.pdf`);

    cont.remove();
  } catch (err) {
    console.error(err);
    alert('No se pudo generar el PDF. Revisa la consola (F12).');
  }
});
</script>


{% endblock %}
