{% extends "panel/grafico.html" %}
{% load static i18n %}

{% block title %}Subir documentos — {{ alumno.numero_estudiante }}{% endblock %}

{% block main_content %}

<style>
  /* Ajustes suaves para el tema oscuro y el input file */
  .public-upload-wrap { max-width: 920px; margin: 0 auto; }
  .public-upload-wrap .card { overflow: visible; }
  .public-upload-wrap input[type="file"]{
    opacity:1 !important; position:static !important; width:100% !important;
    height:auto !important; display:block !important;
  }

  /* Badges de estado */
  .badge-state{border-radius:999px;padding:.3rem .6rem;font-size:.78rem;display:inline-flex;align-items:center;gap:.35rem}
  .badge-state i{font-size:1rem;line-height:1}
  .badge-yes{background:#1f2a21;color:#b9f6ca;border:1px solid #2e7d32}
  .badge-no{background:#2b1f20;color:#ff8a80;border:1px solid #c62828}
  .badge-unk{background:#1f2430;color:#e6eaf2;border:1px solid #394056}

  .table-docs td{vertical-align:middle}
  .table-docs a{white-space:nowrap}

  /* Botón eliminar compacto */
  .btn-xxs{padding:.25rem .5rem;font-size:.75rem;line-height:1;border-radius:.3rem}
</style>

<div class="public-upload-wrap">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h1 class="h4 m-0 text-white">
        <i class="material-icons align-middle mr-1">cloud_upload</i>
        Subir documentos de {{ alumno.nombre }} {{ alumno.apellido_p }} {{ alumno.apellido_m }}
      </h1>
      <p class="m-0 text-muted small">
        Enlace seguro para carga de documentos
        {% if alumno.curp %}
          &nbsp;•&nbsp; CURP: <strong>{{ alumno.curp }}</strong>
        {% endif %}
      </p>
    </div>

    {% if request.user.is_authenticated %}
      <a class="btn btn-outline-secondary" href="{% url 'alumnos_detalle' alumno.pk %}">
        <i class="material-icons align-middle">arrow_back</i> Volver a ficha
      </a>
    {% endif %}
  </div>

  <div class="card">
    <div class="card-header card-header-primary card-header-icon d-flex align-items-center">
      <div class="card-icon"><i class="material-icons">badge</i></div>
      <div>
        <h4 class="card-title m-0">
           {% if invite and invite.expires_at %}
            &nbsp;•&nbsp; Fecha límite para subir documentos: <strong>{{ invite.expires_at|date:"d/m/Y H:i" }}</strong>
          {% endif %}
        </h4>
        <p class="card-category m-0">
          <strong>{{ alumno.informacionEscolar }}</strong>
        
      
        {% comment %}   {% if invite and invite.expires_at %}
            &nbsp;•&nbsp; Fecha límite para subir documentos: <strong>{{ invite.expires_at|date:"d/m/Y H:i" }}</strong>
          {% endif %} {% endcomment %}
        </p>
      </div>
    </div>

    <div class="card-body">

      {# ------ Mensajes Django ------ #}
      {% if messages %}
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:'info' }}">{% autoescape off %}{{ m }}{% endautoescape %}</div>
        {% endfor %}
      {% endif %}

      {# ------ Estado del enlace ------ #}
      {% if invite_is_expired %}
        <div class="alert alert-danger">
          <i class="material-icons align-middle">lock</i>
          Este enlace ha caducado. Por favor, solicita uno nuevo.
        </div>
      {% elif invite_is_revoked %}
        <div class="alert alert-warning">
          <i class="material-icons align-middle">block</i>
          Este enlace ya no está disponible.
        </div>
      {% else %}

        <div class="mb-3 text-muted">
          Selecciona el tipo de documento y luego carga el archivo correspondiente.
          Formatos aceptados habituales: PDF, JPG/PNG.
        </div>

        {# ---- Form de subida: solo si hay faltantes ---- #}
        {% if faltantes_count and faltantes_count > 0 %}
        <form method="post" enctype="multipart/form-data" class="mb-3">
          {% csrf_token %}

          <div class="form-row">
            <div class="form-group col-md-6">
              <label class="bmd-label-floating">{{ form.tipo.label }}</label>
              {{ form.tipo }}
              {% for e in form.tipo.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>

            <div class="form-group col-md-6">
              <label class="bmd-label-floating">{{ form.archivo.label }}</label>
              {{ form.archivo }}
              {% for e in form.archivo.errors %}
                <div class="text-danger small">{{ e }}</div>
              {% endfor %}
            </div>
          </div>

          {% if form.non_field_errors %}
            <div class="text-danger small mb-2">
              {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
            </div>
          {% endif %}

          <button class="btn btn-primary">
            <i class="material-icons align-middle">cloud_upload</i>
            Subir
          </button>
        </form>
        {% else %}
        <div class="alert alert-success">
          <i class="material-icons align-middle">check_circle</i>
          ¡No faltan documentos por subir!
        </div>
        {% endif %}

        {# ------ Resumen de faltantes ------ #}
        {% if faltantes_count is not None %}
          <div class="mb-3">
            {% if faltantes_count == 0 %}
              <span class="badge badge-success">
                <i class="material-icons align-middle" style="font-size:16px">check_circle</i>
                ¡No faltan documentos!
              </span>
            {% else %}
              <span class="badge badge-warning">
                <i class="material-icons align-middle" style="font-size:16px">warning</i>
                Faltan {{ faltantes_count }} documento{% if faltantes_count != 1 %}s{% endif %}
              </span>
              <div class="mt-2">
                {% for t in faltantes %}
                  <span class="badge badge-light badge-missing">{{ t.nombre }}</span>
                {% empty %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endif %}

        {# ================== LISTA COMPLETA DE DOCUMENTOS + ESTADO ================== #}
        <hr>
        <h6 class="text-muted mb-3">
          <i class="material-icons align-middle mr-1">description</i>
          Documentos del alumno
        </h6>

        {% with docs_list=docs|default:uploads %}
          <div class="table-responsive">
            <table class="table table-hover table-docs">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Archivo</th>
                  <th>Estado</th>
                  <th>Notas</th>
                  <th>Fecha</th>
                  <th class="text-right">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for d in docs_list %}
                  <tr>
                    <td>{{ d.tipo.nombre|default:"—" }}</td>
                    <td>
                      {% if d.archivo %}
                        <a href="{{ d.archivo.url }}" target="_blank" rel="noopener">
                          <i class="material-icons align-middle">open_in_new</i> Abrir
                        </a>
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>
                      {% if d.valido is not None %}
                        {% if d.valido %}
                          <span class="badge-state badge-yes">
                            <i class="material-icons">check_circle</i> Válido
                          </span>
                        {% else %}
                          <span class="badge-state badge-no">
                            <i class="material-icons">cancel</i> No válido
                          </span>
                        {% endif %}
                      {% else %}
                        <span class="badge-state badge-unk">
                          <i class="material-icons">help_outline</i> En revisión
                        </span>
                      {% endif %}
                    </td>
                    <td>{{ d.notas|default:"—" }}</td>
                    <td>
                      {% if d.actualizado_en %}
                        {{ d.actualizado_en|date:"d/m/Y H:i" }}
                      {% elif d.creado_en %}
                        {{ d.creado_en|date:"d/m/Y H:i" }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="text-right">
                      {# Mostrar botón Eliminar solo si NO está válido (False o None) #}
                      {% if d.valido != True %}
                        <form method="post" style="display:inline" onsubmit="return confirm('¿Eliminar este documento? Esta acción no se puede deshacer.');">
                          {% csrf_token %}
                          <input type="hidden" name="doc_id" value="{{ d.id }}">
                          <button type="submit" name="delete" value="1" class="btn btn-danger btn-xxs">
                            <i class="material-icons align-middle" style="font-size:16px">delete</i>
                            Eliminar
                          </button>
                        </form>
                      {% else %}
                        <span class="text-muted small">—</span>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="6" class="text-muted">Todavía no hay archivos subidos.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endwith %}

      {% endif %}
    </div>
  </div>
</div>

{% endblock %}
