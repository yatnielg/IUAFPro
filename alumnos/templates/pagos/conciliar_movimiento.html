{% extends "panel/grafico.html" %}
{% block main_content %}

<h3>Conciliar movimiento #{{ mov.id }}</h3>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} mb-3" role="alert">{{ message }}</div>
  {% endfor %}
{% endif %}

<div class="card mb-3">
  <div class="card-body">
    <p><strong>Fecha:</strong> {{ mov.fecha|default:"—" }}</p>
    <p><strong>Monto del movimiento:</strong> ${{ mov.monto|default:"—" }}</p>

    <div class="mb-2">
      <label class="form-label d-block"><strong>Nombre detectado (editable):</strong></label>
      <div class="input-group input-group-sm" style="max-width: 520px;">
        <input type="text" class="form-control"
               id="nombre-detectado-input"
               value="{{ mov.nombre_detectado_save|default_if_none:mov.nombre_detectado|default:'' }}"
               placeholder="Escribe el nombre correcto…"
               readonly>
        <button class="btn btn-outline-secondary" type="button" id="toggle-edit-nds" title="Editar">
          <i class="material-icons" style="vertical-align:middle">edit</i>
        </button>
      </div>
      <small class="text-muted">Este valor se guardará en el movimiento para futuras conciliaciones.</small>
    </div>

    <p class="mb-0"><strong>Emisor:</strong> {{ mov.emisor_nombre|default:"—" }}</p>
    <p class="mb-0"><strong>Detectado (solo lectura):</strong> {{ mov.nombre_detectado|default:"—" }}</p>
    <p class="mb-0"><strong>Referencia:</strong> {{ mov.referencia_numerica|default:"—" }} / {{ mov.autorizacion|default:"—" }}</p>
    <p class="mb-0"><strong>Concepto banco:</strong> {{ mov.concepto|default:"—" }}</p>
  </div>
</div>

<form method="post" id="conciliar-form" action="">
  {% csrf_token %}
  {{ formset.management_form }}

  {% if not formset.management_form %}
    <!-- Fallback por si no se renderiza el management_form -->
    <input type="hidden" name="lineas-TOTAL_FORMS" id="id_lineas-TOTAL_FORMS" value="1">
    <input type="hidden" name="lineas-INITIAL_FORMS" value="0">
    <input type="hidden" name="lineas-MIN_NUM_FORMS" value="0">
    <input type="hidden" name="lineas-MAX_NUM_FORMS" value="1000">
  {% endif %}

  <input type="hidden" name="nombre_detectado_save" id="nds-hidden"
         value="{{ mov.nombre_detectado_save|default_if_none:mov.nombre_detectado|default:'' }}">

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th style="width:28%">Alumno</th>
          <th style="width:32%">Concepto</th>
          <th style="width:20%">Monto</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody id="lineas-body">
        {% for form in formset.forms %}
        <tr class="linea">
          <td>
            <select name="{{ form.prefix }}-alumno_id" class="form-select form-select-sm" required>
              <option value="" hidden>Elige alumno…</option>
              {% for a in candidatos %}
                <option value="{{ a.pk }}">{{ a.numero_estudiante }} — {{ a.nombre }} {{ a.apellido_p }} {{ a.apellido_m }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select name="{{ form.prefix }}-concepto_id" class="form-select form-select-sm" required>
              <option value="" hidden>Elige concepto…</option>
              {% for c in conceptos %}
                <option value="{{ c.pk }}">{{ c.codigo }} — {{ c.nombre }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="number" step="0.01" min="0.01"
                   name="{{ form.prefix }}-monto"
                   class="form-control form-control-sm monto-input"
                   value="{{ form.initial.monto|default_if_none:'' }}"
                   required>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger btn-del" type="button">Quitar</button>
          </td>
          <input type="hidden" name="{{ form.prefix }}-DELETE" class="del-flag" value="">
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" class="text-end fw-semibold">Total de líneas:</td>
          <td><input type="text" class="form-control form-control-sm" id="total-lineas" value="0.00" readonly></td>
          <td></td>
        </tr>
        <tr>
          <td colspan="2" class="text-end fw-semibold">Debe igualar a:</td>
          <td><input type="text" class="form-control form-control-sm" id="monto-debe" value="{{ mov.monto }}" readonly></td>
          <td></td>
        </tr>
        <tr>
          <td colspan="2" class="text-end fw-semibold">Falta por conciliar:</td>
          <td><input type="text" class="form-control form-control-sm" id="faltante-lineas" value="0.00" readonly></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-sm btn-outline-primary" id="add-linea" type="button">+ Agregar línea</button>
  </div>

  <button class="btn btn-primary" type="submit" id="submit-btn">Conciliar y crear pagos</button>
  <a class="btn btn-light" href="{% url 'movimientos_abonos_pendientes' %}">Cancelar</a>
</form>

<!-- plantilla oculta -->
<table class="d-none">
  <tbody>
    <tr id="tpl-linea">
      <td>
        <select class="form-select form-select-sm alumno-select" required>
          <option value="" hidden>Elige alumno…</option>
          {% for a in candidatos %}
            <option value="{{ a.pk }}">{{ a.numero_estudiante }} — {{ a.nombre }} {{ a.apellido_p }} {{ a.apellido_m }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select class="form-select form-select-sm concepto-select" required>
          <option value="" hidden>Elige concepto…</option>
          {% for c in conceptos %}
            <option value="{{ c.pk }}">{{ c.codigo }} — {{ c.nombre }}</option>
          {% endfor %}
        </select>
      </td>
      <td><input type="number" step="0.01" min="0.01" class="form-control form-control-sm monto-input" required></td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger btn-del" type="button">Quitar</button></td>
      <input type="hidden" class="del-flag" value="">
    </tr>
  </tbody>
</table>

<script>
  // ================= Utilidad numérica =================
  function toFloat(val) {
    let s = String(val ?? '').trim().replace(/,/g, '');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  // ✅ Deshabilita inputs de una fila marcada para borrar (evita bloqueo HTML5)
  function disableRow(tr){
    tr.querySelectorAll('select, input').forEach(el => {
      if (el.classList.contains('del-flag')) return; // dejamos el flag
      el.required = false;
      el.disabled = true;
    });
  }

  (function(){
    const addBtn = document.getElementById('add-linea');
    const body = document.getElementById('lineas-body');
    const totalI = document.getElementById('total-lineas');
    const faltI = document.getElementById('faltante-lineas');
    const mgmtTotal = document.getElementById('id_lineas-TOTAL_FORMS');
    const debeInput = document.getElementById('monto-debe');

    function getDebe() { return toFloat(debeInput.value); }

    function recalc() {
      let total = 0;
      body.querySelectorAll('tr.linea').forEach(tr => {
        if (tr.querySelector('.del-flag').value === 'on') return;
        total += toFloat(tr.querySelector('.monto-input').value);
      });
      totalI.value = total.toFixed(2);
      const faltante = getDebe() - total;
      faltI.value = faltante.toFixed(2);
      faltI.classList.remove('is-valid', 'is-invalid');
      if (Math.abs(faltante) < 0.005) faltI.classList.add('is-valid');
      else faltI.classList.add('is-invalid');
    }

    function wireRow(tr) {
      tr.querySelectorAll('.monto-input').forEach(inp => inp.addEventListener('input', recalc));
      tr.querySelector('.btn-del').addEventListener('click', () => {
        const delFlag = tr.querySelector('.del-flag');
        if (delFlag && delFlag.name) {
          // fila existente del formset: marcar DELETE y deshabilitar campos
          delFlag.value = 'on';
          disableRow(tr);
          tr.style.display = 'none';
        } else {
          // fila nueva (sin nombres), eliminar y decrementar TOTAL_FORMS
          tr.remove();
          mgmtTotal.value = String(parseInt(mgmtTotal.value || '0') - 1);
        }
        recalc();
      });
    }

    body.querySelectorAll('tr.linea').forEach(wireRow);
    recalc();

    addBtn.addEventListener('click', () => {
      const idx = parseInt(mgmtTotal.value || 0);
      const tpl = document.getElementById('tpl-linea');
      const tr = tpl.cloneNode(true);
      tr.id = ''; tr.classList.add('linea');
      tr.querySelector('.alumno-select').name = `lineas-${idx}-alumno_id`;
      tr.querySelector('.concepto-select').name = `lineas-${idx}-concepto_id`;
      tr.querySelector('.monto-input').name = `lineas-${idx}-monto`;
      tr.querySelector('.del-flag').name = `lineas-${idx}-DELETE`;
      body.appendChild(tr);
      mgmtTotal.value = String(idx + 1);
      wireRow(tr);
      recalc();
    });

    // ================= Submit =================
    document.getElementById('conciliar-form').addEventListener('submit', (e) => {
      console.log("🔵 Intentando enviar formulario al servidor...");

      // Deshabilitar TODAS las filas marcadas para borrar
      document.querySelectorAll('#lineas-body tr.linea').forEach(tr => {
        const delFlag = tr.querySelector('.del-flag');
        if (delFlag && delFlag.value === 'on') {
          disableRow(tr);
        }
      });

      const total = toFloat(totalI.value);
      const debe = getDebe();
      if (Math.abs(total - debe) > 0.009) {
        e.preventDefault();
        alert(`La suma de líneas (${total.toFixed(2)}) debe ser igual al monto del movimiento (${debe.toFixed(2)}).`);
        console.log("❌ Envío cancelado: montos no coinciden");
        return false;
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerHTML = 'Procesando...';
    });
  })();

  // ================= AJAX: guardar nombre_detectado_save =================
  function getFormCsrf() {
    const form = document.getElementById('conciliar-form');
    const input = form.querySelector('input[name=csrfmiddlewaretoken]');
    return input ? input.value : '';
  }

  (function(){
    const btn = document.getElementById('toggle-edit-nds');
    const input = document.getElementById('nombre-detectado-input');
    const hidden = document.getElementById('nds-hidden');
    if (!btn || !input || !hidden) return;
    const saveUrl = "{% url 'mov_set_nds' mov.id %}";

    let editing = false;
    btn.addEventListener('click', async function(){
      editing = !editing;
      input.readOnly = !editing;

      if (editing) {
        input.focus();
        btn.innerHTML = '<i class="material-icons">done</i>';
        btn.classList.replace('btn-outline-secondary', 'btn-outline-success');
        return;
      }

      hidden.value = input.value;
      btn.disabled = true;
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        const resp = await fetch(saveUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getFormCsrf(),
          },
          body: JSON.stringify({ value: input.value })
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || "No se pudo guardar el nombre.");
        window.location.reload();
      } catch (err) {
        alert(err.message);
        input.readOnly = false;
        btn.innerHTML = originalHTML;
        btn.classList.replace('btn-outline-secondary', 'btn-outline-success');
        editing = true;
      } finally {
        btn.disabled = false;
      }
    });
  })();
</script>

{% endblock %}
